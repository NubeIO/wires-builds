name: release

on:
  push:
    tags:
      - 'v*'

jobs:

  create-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Grep project
        id: grepProject
        shell: bash
        run: |
          targetVersion=$(echo "${{ github.ref }}" | sed -e "s#^refs/tags/v##")
          echo ::set-output name=currentVersion::$(cat package.json | jq -r .version)
          echo ::set-output name=projectName::$(head -n 5 package.json | grep name | cut -d ":" -f2 | grep -oP "(?<=\")([^\"]+)(?=\")")
          echo ::set-output name=targetVersion::$targetVersion

      - name: Validate version
        id: validateVersion
        run: |
          echo "Should Validate Version with semantic..."
          echo "Project name: ${{ steps.grepProject.outputs.projectName }}"
          echo "Current version: ${{ steps.grepProject.outputs.currentVersion }}"
          echo "Target version: ${{ steps.grepProject.outputs.targetVersion }}"
          [[ ${{ steps.grepProject.outputs.currentVersion }} == ${{ steps.grepProject.outputs.targetVersion }} ]] || { echo "Release version and tag version is not match"; exit 1; }

      - name: Create Release
        id: createRelease
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
